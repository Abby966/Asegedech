<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin – Manage Volunteer Tasks</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--brand:#f97316}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .glass{backdrop-filter:blur(10px);background:rgba(255,255,255,.9)}
    .card{transition:transform .2s, box-shadow .2s}
    .card:hover{transform:translateY(-2px); box-shadow:0 12px 30px rgba(2,6,23,.10)}
    .pill{border-radius:999px}
    .shadow-soft{box-shadow:0 10px 30px rgb(2 6 23 / .08)}
    .btn{display:inline-flex;align-items:center;gap:.5rem}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 z-50">
    <div class="absolute inset-0 bg-slate-900/60"></div>
    <div class="relative z-10 mx-auto mt-24 w-full max-w-md rounded-2xl bg-white p-6 shadow-soft">
      <h2 class="text-xl font-extrabold text-slate-900 mb-4">Admin Login</h2>
      <form id="loginForm" class="grid gap-3" novalidate>
        <label class="text-sm font-semibold" for="email">Email</label>
        <!-- use text so "admin" passes validation; still show email keyboard on mobile -->
        <input id="email" type="text" inputmode="email" autocomplete="username"
               class="rounded-xl border border-slate-200 px-3 py-2 shadow-soft" placeholder="admin or admin@example.com" required>
        <label class="text-sm font-semibold" for="password">Password</label>
        <input id="password" type="password" autocomplete="current-password"
               class="rounded-xl border border-slate-200 px-3 py-2 shadow-soft" placeholder="********" required>
        <button type="submit" class="mt-2 pill py-2.5 text-white font-semibold shadow-soft" style="background:var(--brand)">Sign in</button>
        <p id="loginErr" class="hidden text-sm font-semibold text-red-600">Wrong email or password.</p>
      </form>
    </div>
  </div>

  <!-- Top Nav -->
  <header id="adminNav" class="fixed inset-x-0 top-0 z-40 hidden">
    <nav class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="mt-4 mb-3 flex items-center justify-between rounded-2xl bg-white glass px-4 py-2 shadow-soft">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-9 w-9 items-center justify-center rounded-xl text-white" style="background:var(--brand)"><i class="fa-solid fa-clipboard-list"></i></span>
          <span class="font-semibold">Aged Care & Dignity – Admin</span>
        </div>
        <div class="flex items-center gap-2">
          <a class="hover:text-orange-600 text-sm" href="index.html#home">Home</a>
          <a class="hover:text-orange-600 text-sm" href="Volunteer.html">Volunteer</a>
          <button id="logoutBtn" class="pill border border-slate-200 px-3 py-1.5 hover:bg-slate-50 text-sm">Logout</button>
        </div>
      </div>
    </nav>
  </header>

  <!-- Main -->
  <main id="adminMain" class="hidden pt-28 pb-20">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <h1 class="text-2xl md:text-3xl font-extrabold">Admin Task Manager</h1>
      <p class="mt-1 text-slate-600">Create, edit and manage volunteer activities.</p>

      <section class="mt-6 grid gap-4 lg:grid-cols-3">
        <!-- Form -->
        <form id="taskForm" class="card bg-white p-5 rounded-2xl shadow-soft lg:col-span-1">
          <h2 class="text-lg font-bold mb-3">Add / Edit Task</h2>

          <label class="text-sm font-semibold">Title</label>
          <input id="title" class="mt-1 rounded-xl border border-slate-200 px-3 py-2 shadow-soft w-full" required placeholder="e.g., Morning Reading"/>

          <label class="mt-3 text-sm font-semibold">Description</label>
          <textarea id="desc" class="mt-1 rounded-xl border border-slate-200 px-3 py-2 shadow-soft w-full" rows="3" placeholder="Short details…"></textarea>

          <div class="mt-3 grid grid-cols-2 gap-3">
            <div>
              <label class="text-sm font-semibold">Max volunteers/slot</label>
              <input id="capacity" type="number" min="1" class="mt-1 rounded-xl border border-slate-200 px-3 py-2 shadow-soft w-full" placeholder="e.g., 3"/>
            </div>
            <div>
              <label class="text-sm font-semibold">Slot duration (mins)</label>
              <input id="duration" type="number" min="15" step="15" class="mt-1 rounded-xl border border-slate-200 px-3 py-2 shadow-soft w-full" placeholder="60"/>
            </div>
          </div>

          <div class="mt-3">
            <label class="text-sm font-semibold">Task type</label>
            <div class="mt-1 flex gap-3">
              <label class="inline-flex items-center gap-2"><input type="radio" name="type" value="recurring" checked> Recurring</label>
              <label class="inline-flex items-center gap-2"><input type="radio" name="type" value="event"> Event date(s)</label>
            </div>
          </div>

          <div id="recurringBox" class="mt-3">
            <label class="text-sm font-semibold">Days of week</label>
            <div class="mt-2 grid grid-cols-3 gap-2 text-sm">
              <label><input type="checkbox" value="Mon" class="mr-1">Mon</label>
              <label><input type="checkbox" value="Tue" class="mr-1">Tue</label>
              <label><input type="checkbox" value="Wed" class="mr-1">Wed</label>
              <label><input type="checkbox" value="Thu" class="mr-1">Thu</label>
              <label><input type="checkbox" value="Fri" class="mr-1">Fri</label>
              <label><input type="checkbox" value="Sat" class="mr-1">Sat</label>
              <label><input type="checkbox" value="Sun" class="mr-1">Sun</label>
            </div>

            <label class="mt-3 text-sm font-semibold">Time window(s)</label>
            <div id="windows" class="mt-2 grid gap-2">
              <div class="flex items-center gap-2">
                <input type="time" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft" value="09:00">
                <span>–</span>
                <input type="time" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft" value="12:00">
                <button type="button" class="pill px-3 py-2 bg-slate-100 hover:bg-slate-200" data-remove="window">✕</button>
              </div>
            </div>
            <button id="addWindow" type="button" class="mt-2 pill px-3 py-2 text-white" style="background:#0f172a">Add window</button>
          </div>

          <div id="eventBox" class="mt-3 hidden">
            <label class="text-sm font-semibold">Event date(s)</label>
            <div id="dates" class="mt-2 grid gap-2">
              <div class="flex items-center gap-2">
                <input type="date" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft">
                <button type="button" class="pill px-3 py-2 bg-slate-100 hover:bg-slate-200" data-remove="date">✕</button>
              </div>
            </div>
            <button id="addDate" type="button" class="mt-2 pill px-3 py-2 text-white" style="background:#0f172a">Add date</button>
          </div>

          <div class="mt-3 flex items-center gap-2">
            <input id="active" type="checkbox" class="h-4 w-4" checked>
            <label for="active" class="text-sm font-semibold">Active</label>
          </div>

          <div class="mt-4 flex gap-2">
            <button type="submit" class="pill px-4 py-2 text-white" style="background:var(--brand)">Save Task</button>
            <button id="resetForm" type="button" class="pill border border-slate-200 px-4 py-2 hover:bg-slate-100">Reset</button>
          </div>
          <input type="hidden" id="editingId" value="">
        </form>

        <!-- Task list -->
        <section class="lg:col-span-2">
          <div class="card bg-white p-5 rounded-2xl shadow-soft">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <h2 class="text-lg font-bold">Current Tasks</h2>
              <div class="flex items-center gap-2">
                <button id="refreshBtn" class="pill border border-slate-200 px-3 py-2 hover:bg-slate-50">Refresh</button>
              </div>
            </div>
            <div id="taskList" class="mt-4 grid gap-3"></div>
          </div>
        </section>
      </section>
    </div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js" defer></script>
  <script>
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    // ---- Auth ----
    const loginModal = $('#loginModal');
    const adminNav   = $('#adminNav');
    const adminMain  = $('#adminMain');
    const logoutBtn  = $('#logoutBtn');
    const loginErr   = $('#loginErr');

    async function getMe(){
      try {
        const r = await fetch('/api/me', {credentials:'include'});
        return await r.json();
      } catch {
        return { ok:false };
      }
    }
    function showUI(logged){
      loginModal.classList.toggle('hidden', logged);
      adminNav.classList.toggle('hidden', !logged);
      adminMain.classList.toggle('hidden', !logged);
      if (!logged) {
        loginErr.classList.add('hidden');
        $('#password').value = '';
        $('#email').focus();
      }
    }

    $('#loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      let email = $('#email').value.trim();
      const password = $('#password').value;
      if (!email || !password) return;

      // allow "admin" without "@"
      if (email && !email.includes('@')) email = `${email}@example.com`;

      try {
        const r = await fetch('/api/login', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({email, password})
        });
        if(r.ok){
          loginErr.classList.add('hidden');
          showUI(true);
          await loadTasks();
        } else {
          loginErr.textContent = 'Wrong email or password.';
          loginErr.classList.remove('hidden');
        }
      } catch {
        loginErr.textContent = 'Server unreachable. Make sure app.py is running.';
        loginErr.classList.remove('hidden');
      }
    });

    logoutBtn?.addEventListener('click', async ()=>{
      try { await fetch('/api/logout', {method:'POST', credentials:'include'}); } catch {}
      showUI(false);
      $('#taskList').innerHTML = '';
    });

    // ---- Tasks ----
    const listWrap = $('#taskList');
    function taskCard(t){
      const maxVol = t.maxVolunteers ?? '∞';
      const days = (t.daysOfWeek||[]).join(', ') || '-';
      const windows = (t.timeWindows||[]).map(w=>`${w.start}–${w.end}`).join(' | ') || '-';
      const dates = (t.eventDates||[]).join(', ') || '-';
      return `
        <article class="rounded-2xl border border-slate-200 bg-white p-4">
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div>
              <h3 class="text-lg font-bold">${t.title}</h3>
              <p class="text-slate-600 mt-1">${t.description || ''}</p>
              <div class="mt-2 grid grid-cols-2 gap-x-6 gap-y-1 text-sm">
                <div><span class="font-semibold">Capacity</span>: ${maxVol}</div>
                <div><span class="font-semibold">Duration</span>: ${t.slotDurationMins}m</div>
                <div><span class="font-semibold">Type</span>: ${t.type}</div>
                <div><span class="font-semibold">Days</span>: ${days}</div>
                <div class="col-span-2"><span class="font-semibold">Windows</span>: ${windows}</div>
                ${t.type==='event' ? `<div class="col-span-2"><span class="font-semibold">Dates</span>: ${dates}</div>` : ''}
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="pill px-3 py-1 text-xs ${t.active?'bg-green-100 text-green-800':'bg-slate-100 text-slate-700'}">${t.active?'Active':'Inactive'}</span>
              <button class="pill px-3 py-1 border border-slate-200 hover:bg-slate-50" data-edit="${t.id}">Edit</button>
              <button class="pill px-3 py-1 bg-red-50 text-red-700 hover:bg-red-100" data-del="${t.id}">Delete</button>
            </div>
          </div>
        </article>
      `;
    }

    async function loadTasks(){
      listWrap.innerHTML = '<div class="text-slate-500">Loading…</div>';
      const r = await fetch('/api/admin/tasks', {credentials:'include'});
      if (r.status === 401) { showUI(false); return; }
      if(!r.ok){ listWrap.innerHTML = '<div class="text-red-600">Failed to load tasks.</div>'; return; }
      const items = await r.json();
      listWrap.innerHTML = items.length ? items.map(taskCard).join('') : `<div class="rounded-xl border border-dashed border-slate-300 p-6 text-slate-500">No tasks yet. Create one on the left.</div>`;
    }
    $('#refreshBtn').addEventListener('click', loadTasks);

    // Add/remove windows/dates
    $('#addWindow').addEventListener('click', ()=>{
      const row = document.createElement('div');
      row.className = 'flex items-center gap-2';
      row.innerHTML = `
        <input type="time" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft" value="14:00">
        <span>–</span>
        <input type="time" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft" value="17:00">
        <button type="button" class="pill px-3 py-2 bg-slate-100 hover:bg-slate-200" data-remove="window">✕</button>`;
      $('#windows').appendChild(row);
    });
    $('#windows').addEventListener('click', (e)=>{ if(e.target.closest('[data-remove="window"]')) e.target.closest('.flex').remove(); });

    $('#addDate').addEventListener('click', ()=>{
      const row = document.createElement('div');
      row.className = 'flex items-center gap-2';
      row.innerHTML = `
        <input type="date" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft">
        <button type="button" class="pill px-3 py-2 bg-slate-100 hover:bg-slate-200" data-remove="date">✕</button>`;
      $('#dates').appendChild(row);
    });
    $('#dates').addEventListener('click', (e)=>{ if(e.target.closest('[data-remove="date"]')) e.target.closest('.flex').remove(); });

    function getType(){ return document.querySelector('input[name="type"]:checked').value; }
    function setType(val){
      document.querySelectorAll('input[name="type"]').forEach(r=>r.checked = (r.value===val));
      $('#recurringBox').classList.toggle('hidden', val!=='recurring');
      $('#eventBox').classList.toggle('hidden', val!=='event');
    }
    document.addEventListener('change', e=>{ if(e.target.name==='type') setType(getType()); });

    function resetForm(){
      $('#taskForm').reset();
      $('#editingId').value = '';
      setType('recurring');
      $('#windows').innerHTML = `
        <div class="flex items-center gap-2">
          <input type="time" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft" value="09:00">
          <span>–</span>
          <input type="time" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft" value="12:00">
          <button type="button" class="pill px-3 py-2 bg-slate-100 hover:bg-slate-200" data-remove="window">✕</button>
        </div>`;
      $('#dates').innerHTML = `
        <div class="flex items-center gap-2">
          <input type="date" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft">
          <button type="button" class="pill px-3 py-2 bg-slate-100 hover:bg-slate-200" data-remove="date">✕</button>
        </div>`;
    }
    $('#resetForm').addEventListener('click', resetForm);

    // Create/update
    $('#taskForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const idEditing = $('#editingId').value.trim();
      const title = $('#title').value.trim();
      if(!title){ $('#title').focus(); return; }

      const payload = {
        title,
        description: $('#desc').value.trim(),
        maxVolunteers: $('#capacity').value ? Number($('#capacity').value) : null,
        slotDurationMins: $('#duration').value ? Number($('#duration').value) : 60,
        type: getType(),
        daysOfWeek: $$('#recurringBox input[type="checkbox"]:checked').map(cb=>cb.value),
        timeWindows: $$('#windows .flex').map(row=>{
          const [s,e] = row.querySelectorAll('input[type="time"]'); return {start:s.value, end:e.value};
        }),
        eventDates: $$('#eventBox input[type="date"]').map(d=>d.value).filter(Boolean),
        active: $('#active').checked
      };

      const url = idEditing ? `/api/admin/tasks/${idEditing}` : '/api/admin/tasks';
      const method = idEditing ? 'PUT' : 'POST';

      const r = await fetch(url, {
        method, credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (r.status === 401) { showUI(false); return; }
      if(!r.ok){ alert('Save failed'); return; }
      await loadTasks();
      resetForm();
      alert('Saved ✅');
    });

    // Edit / Delete
    document.addEventListener('click', async (e)=>{
      const editBtn = e.target.closest('[data-edit]');
      const delBtn  = e.target.closest('[data-del]');
      if(editBtn){
        const id = editBtn.dataset.edit;
        const r = await fetch('/api/admin/tasks', {credentials:'include'});
        if (r.status === 401) { showUI(false); return; }
        const items = await r.json();
        const t = items.find(x=>String(x.id)===String(id));
        if(!t) return;
        $('#editingId').value = t.id;
        $('#title').value = t.title;
        $('#desc').value = t.description || '';
        $('#capacity').value = t.maxVolunteers ?? '';
        $('#duration').value = t.slotDurationMins ?? 60;
        $('#active').checked = !!t.active;
        setType(t.type || 'recurring');

        // days
        $$('#recurringBox input[type="checkbox"]').forEach(cb=> cb.checked = (t.daysOfWeek||[]).includes(cb.value));
        // windows
        $('#windows').innerHTML = (t.timeWindows||[{start:'09:00',end:'12:00'}]).map(w=>`
          <div class="flex items-center gap-2">
            <input type="time" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft" value="${w.start}">
            <span>–</span>
            <input type="time" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft" value="${w.end}">
            <button type="button" class="pill px-3 py-2 bg-slate-100 hover:bg-slate-200" data-remove="window">✕</button>
          </div>`).join('');
        // dates
        $('#dates').innerHTML = (t.eventDates||['']).map(d=>`
          <div class="flex items-center gap-2">
            <input type="date" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft" value="${d}">
            <button type="button" class="pill px-3 py-2 bg-slate-100 hover:bg-slate-200" data-remove="date">✕</button>
          </div>`).join('');
        window.scrollTo({ top: 0, behavior:'smooth' });
      }
      if(delBtn){
        const id = delBtn.dataset.del;
        if(confirm('Delete this task?')){
          const r = await fetch(`/api/admin/tasks/${id}`, {method:'DELETE', credentials:'include'});
          if (r.status === 401) { showUI(false); return; }
          if(r.ok){ loadTasks(); }
        }
      }
    });

    // ----- Boot sequence -----
    (async function init(){
      // If the URL has ?logout=1, log out *before* checking session
      const qs = new URLSearchParams(location.search);
      if (qs.get('logout') === '1') {
        try { await fetch('/api/logout', { method:'POST', credentials:'include' }); } catch {}
        // remove the query param so refresh doesn't keep logging you out
        qs.delete('logout');
        const newUrl = location.pathname + (qs.toString()?('?'+qs.toString()):'') + location.hash;
        history.replaceState({}, '', newUrl);
      }

      const me = await getMe();
      const logged = me && me.ok === true;
      showUI(logged);
      if (logged) { loadTasks(); }
    })();
  </script>
</body>
</html>
