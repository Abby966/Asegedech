<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin ‚Äì Manage Volunteer Tasks</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+Ethiopic:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { 500:'#f97316', 600:'#ea580c' }
          },
          boxShadow: {
            soft: '0 10px 30px rgb(2 6 23 / 0.08)'
          },
          fontFamily: {
            sans: ['Inter','system-ui','-apple-system','Segoe UI','Roboto','Noto Sans Ethiopic','sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    .glass{backdrop-filter:blur(10px);background:rgba(255,255,255,.9)}
    .card{transition:transform .2s ease, box-shadow .2s ease}
    .card:hover{transform:translateY(-2px); box-shadow:0 12px 30px rgba(2,6,23,.10)}
    .pill{border-radius:999px}
    .field{ @apply rounded-xl border border-slate-200 px-3 py-2 shadow-soft; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/60"></div>
    <div class="relative z-10 mx-auto mt-24 w-full max-w-md rounded-2xl bg-white p-6 shadow-soft">
      <h2 class="text-xl font-extrabold text-slate-900 mb-4" data-i18n="login.title">Admin Login</h2>
      <form id="loginForm" class="grid gap-3">
        <label class="text-sm font-semibold" for="email" data-i18n="login.email">Email</label>
        <input id="email" type="email" class="rounded-xl border border-slate-200 px-3 py-2 shadow-soft" placeholder="admin@example.com" required>
        <label class="text-sm font-semibold" for="password" data-i18n="login.password">Password</label>
        <input id="password" type="password" class="rounded-xl border border-slate-200 px-3 py-2 shadow-soft" placeholder="********" required>
        <button type="submit" class="mt-2 inline-flex items-center justify-center rounded-xl bg-brand-500 py-2.5 text-white font-semibold hover:bg-brand-600">
          <span data-i18n="login.btn">Sign in</span>
        </button>
        <p id="loginErr" class="hidden text-sm font-semibold text-red-600" data-i18n="login.error">Wrong email or password.</p>
      </form>
    </div>
  </div>

  <!-- Top Nav (shown after login) -->
  <header id="adminNav" class="fixed inset-x-0 top-0 z-40 hidden">
    <nav class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="mt-4 mb-3 flex items-center justify-between rounded-2xl bg-white glass px-4 py-2 shadow-soft">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-brand-500 text-white"><i class="fa-solid fa-clipboard-list"></i></span>
          <span class="font-semibold" data-i18n="site.name">Aged Care & Dignity ‚Äì Admin</span>
        </div>
        <ul class="hidden md:flex items-center gap-4 text-sm">
          <li><a href="index.html#home" class="hover:text-brand-600" data-i18n="nav.home">Home</a></li>
          <li><a href="Volunteer.html" class="hover:text-brand-600" data-i18n="nav.volunteer">Volunteer</a></li>
          <li><a href="Donate.html" class="hover:text-brand-600" data-i18n="nav.donate">Donate</a></li>
          
          <li>
            <!-- Language switch -->
            <div class="relative">
              <button id="langBtn" class="pill border border-slate-200 px-3 py-1 text-xs font-semibold hover:bg-slate-50">
                <span id="langLabel">EN</span> <i class="fa-solid fa-chevron-down text-[10px]"></i>
              </button>
              <div id="langMenu" class="absolute right-0 mt-2 hidden min-w-[140px] overflow-hidden rounded-xl bg-white shadow-soft ring-1 ring-slate-200">
                <button data-lang="en" class="block w-full px-3 py-2 text-left text-sm hover:bg-slate-50">English</button>
                <button data-lang="am" class="block w-full px-3 py-2 text-left text-sm hover:bg-slate-50">·ä†·àõ·à≠·äõ</button>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </nav>
  </header>

  <!-- Main -->
  <main id="adminMain" class="hidden pt-28 pb-20">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <h1 class="text-2xl md:text-3xl font-extrabold" data-i18n="admin.title">Admin Task Manager</h1>
      <p class="mt-1 text-slate-600" data-i18n="admin.subtitle">Create, edit and manage volunteer activities.</p>

      <!-- Create / Edit Form -->
      <section class="mt-6 grid gap-4 lg:grid-cols-3">
        <form id="taskForm" class="card bg-white p-5 rounded-2xl shadow-soft lg:col-span-1">
          <h2 class="text-lg font-bold mb-3" data-i18n="form.heading">Add / Edit Task</h2>

          <label class="text-sm font-semibold" data-i18n="form.title">Title</label>
          <input id="title" class="mt-1 rounded-xl border border-slate-200 px-3 py-2 shadow-soft w-full" required placeholder="e.g., Morning Reading"/>

          <label class="mt-3 text-sm font-semibold" data-i18n="form.desc">Description</label>
          <textarea id="desc" class="mt-1 rounded-xl border border-slate-200 px-3 py-2 shadow-soft w-full" rows="3" placeholder="Short details‚Ä¶"></textarea>

          <div class="mt-3 grid grid-cols-2 gap-3">
            <div>
              <label class="text-sm font-semibold" data-i18n="form.capacity">Max volunteers/slot</label>
              <input id="capacity" type="number" min="1" class="mt-1 rounded-xl border border-slate-200 px-3 py-2 shadow-soft w-full" placeholder="e.g., 3"/>
            </div>
            <div>
              <label class="text-sm font-semibold" data-i18n="form.duration">Slot duration (mins)</label>
              <input id="duration" type="number" min="15" step="15" class="mt-1 rounded-xl border border-slate-200 px-3 py-2 shadow-soft w-full" placeholder="60"/>
            </div>
          </div>

          <div class="mt-3">
            <label class="text-sm font-semibold" data-i18n="form.type">Task type</label>
            <div class="mt-1 flex gap-3">
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="type" value="recurring" checked>
                <span data-i18n="form.type_rec">Recurring</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="type" value="event">
                <span data-i18n="form.type_evt">Event date(s)</span>
              </label>
            </div>
          </div>

          <!-- Recurring controls -->
          <div id="recurringBox" class="mt-3">
            <label class="text-sm font-semibold" data-i18n="form.days">Days of week</label>
            <div class="mt-2 grid grid-cols-3 gap-2 text-sm">
              <label><input type="checkbox" value="Mon" class="mr-1">Mon</label>
              <label><input type="checkbox" value="Tue" class="mr-1">Tue</label>
              <label><input type="checkbox" value="Wed" class="mr-1">Wed</label>
              <label><input type="checkbox" value="Thu" class="mr-1">Thu</label>
              <label><input type="checkbox" value="Fri" class="mr-1">Fri</label>
              <label><input type="checkbox" value="Sat" class="mr-1">Sat</label>
              <label><input type="checkbox" value="Sun" class="mr-1">Sun</label>
            </div>

            <label class="mt-3 text-sm font-semibold" data-i18n="form.window">Time window(s)</label>
            <div id="windows" class="mt-2 grid gap-2">
              <div class="flex items-center gap-2">
                <input type="time" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft" value="09:00">
                <span>‚Äì</span>
                <input type="time" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft" value="12:00">
                <button type="button" class="pill px-3 py-2 bg-slate-100 hover:bg-slate-200" data-action="remove-window">‚úï</button>
              </div>
            </div>
            <button id="addWindow" type="button" class="mt-2 pill bg-slate-900 px-3 py-2 text-white hover:bg-slate-800" data-i18n="form.add_window">Add window</button>
          </div>

          <!-- Event controls -->
          <div id="eventBox" class="mt-3 hidden">
            <label class="text-sm font-semibold" data-i18n="form.event_dates">Event date(s)</label>
            <div id="dates" class="mt-2 grid gap-2">
              <div class="flex items-center gap-2">
                <input type="date" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft">
                <button type="button" class="pill px-3 py-2 bg-slate-100 hover:bg-slate-200" data-action="remove-date">‚úï</button>
              </div>
            </div>
            <button id="addDate" type="button" class="mt-2 pill bg-slate-900 px-3 py-2 text-white hover:bg-slate-800" data-i18n="form.add_date">Add date</button>
          </div>

          <div class="mt-3 flex items-center gap-2">
            <input id="active" type="checkbox" class="h-4 w-4">
            <label for="active" class="text-sm font-semibold" data-i18n="form.active">Active</label>
          </div>

          <div class="mt-4 flex gap-2">
            <button type="submit" class="pill bg-brand-500 px-4 py-2 text-white hover:bg-brand-600" data-i18n="form.save">Save Task</button>
            <button id="resetForm" type="button" class="pill border border-slate-200 px-4 py-2 hover:bg-slate-100" data-i18n="form.reset">Reset</button>
          </div>
          <input type="hidden" id="editingId" value="">
        </form>

        <!-- Task list -->
        <section class="lg:col-span-2">
          <div class="card bg-white p-5 rounded-2xl shadow-soft">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <h2 class="text-lg font-bold" data-i18n="list.heading">Current Tasks</h2>
              <div class="flex items-center gap-2">
                <button id="exportCsv" class="pill border border-slate-200 px-3 py-2 hover:bg-slate-50" data-i18n="list.export">Export CSV</button>
                <button id="seedOccasions" class="pill border border-slate-200 px-3 py-2 hover:bg-slate-50" title="Add Meskel/New Year/Eid again">Seed occasions</button>
              </div>
            </div>
            <div id="taskList" class="mt-4 grid gap-3"></div>
          </div>
        </section>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer id="adminFooter" class="hidden border-t border-slate-200 bg-white py-8">
    <div class="mx-auto max-w-7xl px-6 text-sm text-slate-600">
      <p>¬© <span id="yr"></span> Aged Care & Dignity Center ‚Äî Admin</p>
    </div>
  </footer>

  <!-- Icons -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js" defer></script>

  <script>
    // ---------- i18n (EN/AM) ----------
    const I18N = {
      en: {
        "site.name":"Aged Care & Dignity ‚Äì Admin",
        "nav.home":"Home","nav.volunteer":"Volunteer","nav.donate":"Donate",
        "login.title":"Admin Login","login.email":"Email","login.password":"Password","login.btn":"Sign in","login.error":"Wrong email or password.",
        "admin.title":"Admin Task Manager","admin.subtitle":"Create, edit and manage volunteer activities.",
        "form.heading":"Add / Edit Task","form.title":"Title","form.desc":"Description","form.capacity":"Max volunteers/slot","form.duration":"Slot duration (mins)","form.type":"Task type","form.type_rec":"Recurring","form.type_evt":"Event date(s)","form.days":"Days of week","form.window":"Time window(s)","form.add_window":"Add window","form.event_dates":"Event date(s)","form.add_date":"Add date","form.active":"Active","form.save":"Save Task","form.reset":"Reset",
        "list.heading":"Current Tasks","list.export":"Export CSV",
        "card.capacity":"Capacity","card.duration":"Duration","card.type":"Type","card.recurring":"Recurring","card.event":"Event","card.days":"Days","card.windows":"Windows","card.dates":"Dates","card.active":"Active","card.inactive":"Inactive","card.edit":"Edit","card.delete":"Delete","card.appts":"Appointments"
      },
      am: {
        "site.name":"·ã®·ä†·à®·åã·ãç·ã´·äï ·ä•·äï·ä≠·â•·ä´·â§ ‚Äì ·ä†·àµ·â∞·ã≥·ã≥·à™",
        "nav.home":"·àò·äê·àª","nav.volunteer":"·â†·çà·âÉ·ãµ ·à•·à´","nav.donate":"·àò·àà·åà·àµ",
        "login.title":"·ã®·ä†·àµ·â∞·ã≥·ã≥·à™ ·àò·åç·â¢·ã´","login.email":"·ä¢·àú·àç","login.password":"·ã®·ã≠·àà·çç ·âÉ·àç","login.btn":"·åç·â£","login.error":"·ã®·â∞·à≥·à≥·â∞ ·ä¢·àú·àç ·ãà·ã≠·àù ·ã®·ã≠·àà·çç ·âÉ·àç·ç¢",
        "admin.title":"·ã®·â∞·åç·â£·à≠ ·ä†·àµ·â∞·ã≥·ã∞·à≠","admin.subtitle":"·ã®·â†·åé ·çà·âÉ·ã∞·äõ ·â∞·åç·â£·à´·âµ·äï ·çç·å†·à≠ ·ä•·äì ·ä†·àµ·â∞·ã≥·ãµ·à≠·ç¢",
        "form.heading":"·â∞·åç·â£·à≠ ·å®·àù·à≠ / ·ä†·àµ·â∞·ä´·ä≠·àç","form.title":"·à≠·ãï·àµ","form.desc":"·àò·åç·àà·å´","form.capacity":"·ä®·çç·â∞·äõ ·â∞·ä´·çã·ãÆ·âΩ/·à∞·ä†·âµ","form.duration":"·ã®·à∞·ä†·âµ ·åä·ãú (·ã∞·âÇ·âÉ)","form.type":"·ãì·ã≠·äê·âµ","form.type_rec":"·ã®·àö·ã∞·åã·åà·àù","form.type_evt":"·ã®·ä≠·àµ·â∞·âµ ·âÄ·äì·âµ","form.days":"·ã®·à≥·àù·äï·âµ ·âÄ·äì·âµ","form.window":"·ã®·à∞·ä†·âµ ·ä≠·àç·àé·âΩ","form.add_window":"·ä≠·àç·àç ·å®·àù·à≠","form.event_dates":"·ã®·ä≠·àµ·â∞·âµ ·âÄ·äì·âµ","form.add_date":"·âÄ·äï ·å®·àù·à≠","form.active":"·äï·âÅ","form.save":"·ä†·àµ·âÄ·àù·å•","form.reset":"·à∞·à≠·ãù",
        "list.heading":"·ã®·ä†·àÅ·äë ·â∞·åç·â£·à´·âµ","list.export":"CSV ·â∞·à≠·âµ·à≠",
        "card.capacity":"·ä≠·àù·âΩ·âµ","card.duration":"·ã®·à∞·ä†·âµ ·åä·ãú","card.type":"·ãì·ã≠·äê·âµ","card.recurring":"·ã®·àö·ã∞·åã·åà·àù","card.event":"·ä≠·àµ·â∞·âµ","card.days":"·âÄ·äì·âµ","card.windows":"·ä≠·àç·àé·âΩ","card.dates":"·âÄ·äì·âµ","card.active":"·äï·âÅ","card.inactive":"·ä•·äï·âÖ·çã·âµ","card.edit":"·ä†·àµ·â∞·ä´·ä≠·àç","card.delete":"·à∞·à≠·ãù","card.appts":"·âÄ·å†·àÆ·ãé·âΩ"
      }
    };
    function applyI18n(lang){
      const dict = I18N[lang] || I18N.en;
      document.documentElement.lang = lang === 'am' ? 'am':'en';
      document.getElementById('langLabel').textContent = lang.toUpperCase();
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n'); const val = dict[key] ?? I18N.en[key];
        if(val!==undefined){ el.textContent = val; }
      });
    }
  </script>

  <script>
    // ---------- State + Storage ----------
    const LS_TASKS = 'volunteerTasks';                 // shared with Volunteer.html
    const LS_APPTS = 'volunteerAppointments';          // shared with Volunteer.html

    const state = {
      tasks: [],
      appts: JSON.parse(localStorage.getItem(LS_APPTS) || '{}')
    };

    function loadTasks(){
      const raw = JSON.parse(localStorage.getItem(LS_TASKS) || '[]');
      // upgrade any old/simple records
      state.tasks = raw.map(t => ({
        id: t.id || slug(t.title) + '-' + (t.createdAt || Date.now()),
        title: t.title || '',
        description: t.description || '',
        maxVolunteers: t.maxVolunteers ?? null,
        slotDurationMins: t.slotDurationMins ?? 60,
        type: t.type || 'recurring',
        daysOfWeek: t.daysOfWeek || t.days || [],
        timeWindows: t.timeWindows || [{start:'09:00', end:'12:00'}],
        eventDates: t.eventDates || [],
        active: (typeof t.active === 'boolean') ? t.active : true,
        createdAt: t.createdAt || Date.now(),
        updatedAt: Date.now()
      }));
    }
    function saveTasks(){
      localStorage.setItem(LS_TASKS, JSON.stringify(state.tasks));
    }
    function slug(s){ return (s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }

    // ---------- Render ----------
    const taskList = () => document.getElementById('taskList');

    function renderTasks(){
      const wrap = taskList(); wrap.innerHTML = '';
      if(state.tasks.length === 0){
        wrap.innerHTML = `<div class="rounded-xl border border-dashed border-slate-300 p-6 text-slate-500">No tasks yet. Create one on the left.</div>`;
        return;
      }
      state.tasks.forEach(t=>{
        const maxVol = t.maxVolunteers ?? '‚àû';
        const days = (t.daysOfWeek||[]).join(', ') || '-';
        const windows = (t.timeWindows||[]).map(w=>`${w.start}‚Äì${w.end}`).join(' | ') || '-';
        const dates = (t.eventDates||[]).join(', ') || '-';
        const appts = (state.appts[t.id]||[]);

        const card = document.createElement('article');
        card.className = 'card rounded-2xl border border-slate-200 bg-white p-4';
        card.innerHTML = `
          <div class="flex flex-wrap items-start justify-between gap-3">
            <div>
              <h3 class="text-lg font-bold">${t.title}</h3>
              <p class="text-slate-600 mt-1">${t.description || ''}</p>
              <div class="mt-2 grid grid-cols-2 gap-x-6 gap-y-1 text-sm">
                <div><span class="font-semibold" data-i18n="card.capacity">Capacity</span>: ${maxVol}</div>
                <div><span class="font-semibold" data-i18n="card.duration">Duration</span>: ${t.slotDurationMins}m</div>
                <div><span class="font-semibold" data-i18n="card.type">Type</span>: <span>${t.type==='recurring' ? '<span data-i18n="card.recurring">Recurring</span>' : '<span data-i18n="card.event">Event</span>'}</span></div>
                <div><span class="font-semibold" data-i18n="card.days">Days</span>: ${days}</div>
                <div class="col-span-2"><span class="font-semibold" data-i18n="card.windows">Windows</span>: ${windows}</div>
                ${t.type==='event' ? `<div class="col-span-2"><span class="font-semibold" data-i18n="card.dates">Dates</span>: ${dates}</div>` : ''}
                <div class="col-span-2"><span class="font-semibold" data-i18n="card.appts">Appointments</span>: ${appts.length}</div>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="pill px-3 py-1 text-xs ${t.active?'bg-green-100 text-green-800':'bg-slate-100 text-slate-700'}">
                ${t.active?'<span data-i18n="card.active">Active</span>':'<span data-i18n="card.inactive">Inactive</span>'}
              </span>
              <button class="pill px-3 py-1 border border-slate-200 hover:bg-slate-50" data-action="edit" data-id="${t.id}" data-i18n="card.edit">Edit</button>
              <button class="pill px-3 py-1 bg-red-50 text-red-700 hover:bg-red-100" data-action="delete" data-id="${t.id}" data-i18n="card.delete">Delete</button>
            </div>
          </div>
          <div class="mt-3 rounded-xl border border-slate-200 p-3 bg-slate-50">
            ${appts.length===0 ? '<em class="text-slate-500">No appointments</em>' :
              appts.map(a=>`
                <div class="flex flex-wrap items-center gap-3 border-b last:border-0 border-slate-200 py-1 text-sm">
                  <span>üìÖ ${a.date}</span>
                  <span>‚è∞ ${a.startTime}‚Äì${a.endTime}</span>
                  <span>üìû ${a.phone}</span>
                </div>`).join('')}
          </div>
        `;
        wrap.appendChild(card);
      });
      // re-apply i18n to new nodes
      applyI18n(localStorage.getItem('lang') || 'en');
    }

    // ---------- Form logic ----------
    const $ = (id)=>document.getElementById(id);
    const form = $('taskForm');

    function getType(){ return form.querySelector('input[name="type"]:checked').value; }
    function setType(val){
      form.querySelectorAll('input[name="type"]').forEach(r=>r.checked = (r.value===val));
      $('recurringBox').classList.toggle('hidden', val!=='recurring');
      $('eventBox').classList.toggle('hidden', val!=='event');
    }

    form.addEventListener('change', (e)=>{
      if(e.target.name==='type'){ setType(getType()); }
    });

    $('addWindow').addEventListener('click', ()=>{
      const row = document.createElement('div');
      row.className = 'flex items-center gap-2';
      row.innerHTML = `
        <input type="time" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft" value="14:00">
        <span>‚Äì</span>
        <input type="time" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft" value="17:00">
        <button type="button" class="pill px-3 py-2 bg-slate-100 hover:bg-slate-200" data-action="remove-window">‚úï</button>
      `;
      $('windows').appendChild(row);
    });
    $('windows').addEventListener('click', (e)=>{
      if(e.target.closest('[data-action="remove-window"]')) e.target.closest('.flex').remove();
    });

    $('addDate').addEventListener('click', ()=>{
      const row = document.createElement('div');
      row.className = 'flex items-center gap-2';
      row.innerHTML = `
        <input type="date" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft">
        <button type="button" class="pill px-3 py-2 bg-slate-100 hover:bg-slate-200" data-action="remove-date">‚úï</button>
      `;
      $('dates').appendChild(row);
    });
    $('dates').addEventListener('click', (e)=>{
      if(e.target.closest('[data-action="remove-date"]')) e.target.closest('.flex').remove();
    });

    $('resetForm').addEventListener('click', ()=>resetForm());

    function resetForm(){
      form.reset();
      $('editingId').value = '';
      setType('recurring');
      // reset windows/dates to one row each
      $('windows').innerHTML = `
        <div class="flex items-center gap-2">
          <input type="time" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft" value="09:00">
          <span>‚Äì</span>
          <input type="time" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft" value="12:00">
          <button type="button" class="pill px-3 py-2 bg-slate-100 hover:bg-slate-200" data-action="remove-window">‚úï</button>
        </div>`;
      $('dates').innerHTML = `
        <div class="flex items-center gap-2">
          <input type="date" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft">
          <button type="button" class="pill px-3 py-2 bg-slate-100 hover:bg-slate-200" data-action="remove-date">‚úï</button>
        </div>`;
    }

    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const idEditing = $('editingId').value.trim();
      const title = $('title').value.trim();
      if(!title){ $('title').focus(); return; }

      const obj = {
        id: idEditing || (slug(title) + '-' + Date.now()),
        title,
        description: $('desc').value.trim(),
        maxVolunteers: $('capacity').value ? Number($('capacity').value) : null,
        slotDurationMins: $('duration').value ? Number($('duration').value) : 60,
        type: getType(),
        daysOfWeek: Array.from(form.querySelectorAll('#recurringBox input[type="checkbox"]:checked')).map(i=>i.value),
        timeWindows: Array.from(form.querySelectorAll('#windows .flex')).map(row=>{
          const [s,e] = row.querySelectorAll('input[type="time"]'); return {start:s.value, end:e.value};
        }),
        eventDates: Array.from(form.querySelectorAll('#eventBox input[type="date"]')).map(d=>d.value).filter(Boolean),
        active: $('active').checked,
        updatedAt: Date.now()
      };
      if(idEditing){
        const idx = state.tasks.findIndex(t=>t.id===idEditing);
        if(idx>-1) state.tasks[idx] = { ...state.tasks[idx], ...obj };
      }else{
        obj.createdAt = Date.now();
        state.tasks.unshift(obj);
      }
      saveTasks();
      renderTasks();
      resetForm();
      alert('Saved ‚úÖ');
    });

    // Edit/Delete handlers
    document.addEventListener('click', (e)=>{
      const editBtn = e.target.closest('[data-action="edit"]');
      const delBtn  = e.target.closest('[data-action="delete"]');
      if(editBtn){
        const t = state.tasks.find(x=>x.id===editBtn.dataset.id);
        if(!t) return;
        $('editingId').value = t.id;
        $('title').value = t.title;
        $('desc').value = t.description || '';
        $('capacity').value = t.maxVolunteers ?? '';
        $('duration').value = t.slotDurationMins ?? 60;
        $('active').checked = !!t.active;
        setType(t.type || 'recurring');

        // days
        form.querySelectorAll('#recurringBox input[type="checkbox"]').forEach(cb=>{
          cb.checked = (t.daysOfWeek || []).includes(cb.value);
        });
        // windows
        $('windows').innerHTML = (t.timeWindows||[{start:'09:00',end:'12:00'}]).map(w=>`
          <div class="flex items-center gap-2">
            <input type="time" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft" value="${w.start}">
            <span>‚Äì</span>
            <input type="time" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft" value="${w.end}">
            <button type="button" class="pill px-3 py-2 bg-slate-100 hover:bg-slate-200" data-action="remove-window">‚úï</button>
          </div>`).join('');
        // dates
        $('dates').innerHTML = (t.eventDates||['']).map(d=>`
          <div class="flex items-center gap-2">
            <input type="date" class="w-full rounded-xl border border-slate-200 px-3 py-2 shadow-soft" value="${d}">
            <button type="button" class="pill px-3 py-2 bg-slate-100 hover:bg-slate-200" data-action="remove-date">‚úï</button>
          </div>`).join('');
        window.scrollTo({ top: 0, behavior:'smooth' });
      }
      if(delBtn){
        const id = delBtn.dataset.id;
        if(confirm('Delete this task?')){
          state.tasks = state.tasks.filter(t=>t.id!==id);
          saveTasks();
          renderTasks();
        }
      }
    });

    // Export CSV
    function exportCSV(){
      const rows = [['id','title','description','maxVolunteers','slotDurationMins','type','daysOfWeek','timeWindows','eventDates','active','createdAt','updatedAt']];
      state.tasks.forEach(t=>{
        rows.push([
          t.id, t.title, (t.description||'').replace(/\n/g,' '),
          t.maxVolunteers ?? '', t.slotDurationMins ?? '',
          t.type,
          (t.daysOfWeek||[]).join('/'),
          (t.timeWindows||[]).map(w=>`${w.start}-${w.end}`).join('/'),
          (t.eventDates||[]).join('/'),
          t.active ? '1':'0',
          t.createdAt||'', t.updatedAt||''
        ]);
      });
      const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'tasks.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }
    document.getElementById('exportCsv').addEventListener('click', exportCSV);

    // Seed occasions (Meskel, New Year, Eid)
    document.getElementById('seedOccasions').addEventListener('click', ()=>{
      const seeds = [
        {title:'Celebrate Meskel', description:'Orthodox holiday on Sept 27', type:'event', eventDates:['2025-09-27'], maxVolunteers:1, active:true},
        {title:'Ethiopian New Year (Enkutatash)', description:'Sept 11', type:'event', eventDates:['2025-09-11'], maxVolunteers:1, active:true},
        {title:'Eid Support', description:'Community celebration', type:'event', eventDates:[], maxVolunteers:1, active:true}
      ];
      seeds.forEach(s=>{
        state.tasks.unshift({
          id: slug(s.title)+'-'+Date.now()+Math.floor(Math.random()*1000),
          description:'', slotDurationMins:60, daysOfWeek:[], timeWindows:[{start:'09:00',end:'12:00'}],
          createdAt:Date.now(), updatedAt:Date.now(), ...s
        });
      });
      saveTasks(); renderTasks();
    });

    // ---------- Auth (simple for now; swap to Firebase later) ----------
    const loginModal = document.getElementById('loginModal');
    const adminNav   = document.getElementById('adminNav');
    const adminMain  = document.getElementById('adminMain');
    const adminFooter= document.getElementById('adminFooter');

    const ALLOWED  = ["admin@example.com"];           // CHANGE ME (allowlisted emails)
    const PASSWORDS= {"admin@example.com":"admin"}; // CHANGE ME

    function showUI(loggedIn){
      loginModal.classList.toggle('hidden', !!loggedIn);
      adminNav.classList.toggle('hidden', !loggedIn);
      adminMain.classList.toggle('hidden', !loggedIn);
      adminFooter.classList.toggle('hidden', !loggedIn);
    }

    document.getElementById('loginForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const email = document.getElementById('email').value.trim().toLowerCase();
      const pass  = document.getElementById('password').value;
      const ok = ALLOWED.includes(email) && PASSWORDS[email] === pass;
      if(ok){
        sessionStorage.setItem('isAdmin','1');
        document.getElementById('loginErr').classList.add('hidden');
        showUI(true);
        loadTasks(); renderTasks();
      }else{
        document.getElementById('loginErr').classList.remove('hidden');
      }
    });

   

    // Language switch
    (function initLang(){
      const saved = localStorage.getItem('lang') || 'en';
      applyI18n(saved);
      const btn  = document.getElementById('langBtn');
      const menu = document.getElementById('langMenu');
      btn?.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('hidden'); });
      document.addEventListener('click', ()=> menu.classList.add('hidden'));
      menu?.querySelectorAll('[data-lang]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const code = b.getAttribute('data-lang'); localStorage.setItem('lang', code);
          applyI18n(code); menu.classList.add('hidden');
          // re-render to update newly injected labels too
          renderTasks();
        });
      });
    })();

    // Init
    document.getElementById('yr').textContent = new Date().getFullYear();
    if(sessionStorage.getItem('isAdmin')==='1'){
      showUI(true); loadTasks(); renderTasks();
    }else{
      showUI(false);
    }
  </script>
</body>
</html>
Logout